<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page.title | default: site.title }}</title>
  <link rel="icon" href="/assets/img/adjmatrix_black.png" media="(prefers-color-scheme: no-preference), (prefers-color-scheme: light)">
  <link rel="icon" href="/assets/img/adjmatrix.png" media="(prefers-color-scheme: dark)">
  <link rel="stylesheet" href="/assets/css/template/page.css">
  <link rel="stylesheet" href="/assets/css/template/book.css">
  <link rel="stylesheet" href="/assets/css/template/theme.css">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" 
          onload="renderMathInElement(document.body, {delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false} ]});"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
</head>

<body>
  <header>
    <div class="header-logo-wrapper">
      <a href="https://www.adjmatrix.site/" id="logo"><img src="/assets/img/adjmatrix_black.png"></a>
    </div>
    <div class="header-title-wrapper">
      <a href="https://www.adjmatrix.site/pages" class="header-title">
        <h1>{{ page.title }}</h1>
      </a>
    </div>
  </header>
  <!-- 纯CSS实现的汉堡菜单和侧边栏 -->
  <label for="toggle-toc" id="toggle-toc-click"><span class="line line1"></span><span class="line line2"></span><span class="line line3"></span></label>
  <div class="with-toc">
    <nav id="toc">
      <input type="checkbox" id="toggle-toc">
      <div class="first">
        <div class="split-tocs">
          <!-- Main and sub-TOCs will be generated here by JavaScript -->
        </div>
      </div>
      <div class="last"><ul id="meta-links">
        <li><a href="https://www.adjmatrix.site/">Home</a></li>
        <li><a href="https://www.adjmatrix.site/pages">Content</a></li>
      </ul></div>
    </nav>
    <main>
      <div class="content-wrapper">
        {{ content }}
      </div>
    </main>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="/assets/js/jquery.nav.js"></script>
  <script>
    $(document).ready(function() {

        function generateCatalog() {
            var container = $('.split-tocs');
            var content = $('.content-wrapper');
            if (container.length === 0 || content.length === 0) return;

            container.empty();

            var headers = content.find('h2, h3');
            if (headers.length === 0) return;

            // --- Create the main "Table of Contents" (Book TOC) ---
            var bookToc = $('<div class="split-toc book"></div>');
            var bookTocTitle = $('<div class="title"><label for="--verso-manual-toc-----bookRoot" class="toggle-split-toc"><input type="checkbox" class="toggle-split-toc" id="--verso-manual-toc-----bookRoot" checked="checked"></label><span class="">Table of Contents</span></div>');
            var bookTocTable = $('<table><tbody></tbody></table>');
            bookToc.append(bookTocTitle).append(bookTocTable);
            container.append(bookToc);
            
            var mainTocBody = bookTocTable.find('tbody');
            var h2Counter = 0;

            // --- Create Chapter-level TOCs ---
            headers.filter('h2').each(function() {
                h2Counter++;
                var h2 = $(this);
                var h2_id = h2.attr('id') || 'gen-h2-' + h2Counter;
                h2.attr('id', h2_id);

                var mainTr = $('<tr class="numbered"></tr>')
                    .append($('<td class="num"></td>').text(h2Counter + '.'))
                    .append($('<td></td>').append($('<a href="#' + h2_id + '"></a>').text(h2.text())));
                mainTocBody.append(mainTr);

                var chapterToc = $('<div class="split-toc"></div>');
                var chapterTitle = $('<div class="title"></div>')
                    .append('<label for="--verso-manual-toc-Intro' + h2Counter + '" class="toggle-split-toc"><input type="checkbox" class="toggle-split-toc" id="--verso-manual-toc-Intro' + h2Counter + '" checked="checked"></label>')
                    .append('<span class="number">' + h2Counter + '.</span>&nbsp;')
                    .append($('<span></span>').addClass('chapter-title-span').attr('data-h2-id', h2_id).text(h2.text()));
                chapterToc.append(chapterTitle);

                var h3s = h2.nextUntil('h2').filter('h3');
                if (h3s.length > 0) {
                    var chapterTable = $('<table><tbody></tbody></table>');
                    var h3Counter = 0;
                    h3s.each(function() {
                        h3Counter++;
                        var h3 = $(this);
                        var h3_id = h3.attr('id') || 'gen-h3-' + h2Counter + '-' + h3Counter;
                        h3.attr('id', h3_id);

                        var subTr = $('<tr class="numbered"></tr>')
                            .append($('<td class="num"></td>').text(h2Counter + '.' + h3Counter + '.'))
                            .append($('<td></td>').append($('<a href="#' + h3_id + '"></a>').text(h3.text())));
                        chapterTable.find('tbody').append(subTr);
                    });
                    chapterToc.append(chapterTable);
                }
                container.append(chapterToc);
            });
        }

        generateCatalog();

        var mainNavContainer = $('.split-tocs');
        if (mainNavContainer.find('a').length > 0) {
            mainNavContainer.onePageNav({
                currentClass: 'current',
                navItems: 'a',
                changeHash: false,
                scrollSpeed: 750,
                scrollThreshold: 0.2,
                padding: 40,
                scrollChange: function($current) {
                    mainNavContainer.find('tr').removeClass('current');
                    mainNavContainer.find('.chapter-title-span').removeClass('current');

                    var activeTr = $current.closest('tr');
                    activeTr.addClass('current');
                    
                    var href = $current.attr('href');
                    var targetId = href.substring(1);
                    var $targetHeader = $('#' + targetId);

                    var $activeH2 = $targetHeader.is('h2') ? $targetHeader : $targetHeader.prevAll('h2').first();
                    var activeH2Id = $activeH2.attr('id');
                    
                    mainNavContainer.find('.chapter-title-span[data-h2-id="' + activeH2Id + '"]').addClass('current');
                }
            });
        }
    });
  </script>
</body>

</html>